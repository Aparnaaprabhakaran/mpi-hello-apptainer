name: Test mpi_hello with Apptainer

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Apptainer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libseccomp-dev pkg-config \
            squashfuse fuse2fs libfuse2 cryptsetup curl

      - name: Install Apptainer
        run: |
          export VERSION=1.2.5
          curl -LO https://github.com/apptainer/apptainer/releases/download/v${VERSION}/apptainer_${VERSION}_amd64.deb
          sudo dpkg -i apptainer_${VERSION}_amd64.deb

      - name: Build container from your mpi_hello.def
        run: |
          apptainer build mpi_hello.sif mpi_hello.def

      - name: Compile your mpi_hello.c
        run: |
          mpicc -o mpi_hello mpi_hello.c

      - name: Run your MPI Hello inside the container
        run: |
          apptainer exec mpi_hello.sif mpirun -np 2 ./mpi_hello
